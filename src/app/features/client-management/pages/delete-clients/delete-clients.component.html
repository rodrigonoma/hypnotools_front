<div class="delete-clients-container">
  <!-- Header -->
  <div class="header">
    <h1>
      <mat-icon>delete_forever</mat-icon>
      Exclusão de Clientes em Massa
    </h1>
    <p class="warning-text">
      ⚠️ <strong>ATENÇÃO:</strong> Esta operação é irreversível e afetará múltiplas tabelas do banco de dados.
    </p>
  </div>

  <!-- Progress Steps -->
  <div class="steps-indicator">
    <div class="step" [class.active]="currentStep === 1" [class.completed]="currentStep > 1">
      <span class="step-number">1</span>
      <span class="step-label">Entrada de Dados</span>
    </div>
    <div class="step" [class.active]="currentStep === 2" [class.completed]="currentStep > 2">
      <span class="step-number">2</span>
      <span class="step-label">Validação</span>
    </div>
    <div class="step" [class.active]="currentStep === 3" [class.completed]="currentStep > 3">
      <span class="step-number">3</span>
      <span class="step-label">Confirmação</span>
    </div>
    <div class="step" [class.active]="currentStep === 4">
      <span class="step-number">4</span>
      <span class="step-label">Execução</span>
    </div>
  </div>

  <form [formGroup]="deletionForm">

    <!-- Step 1: Data Input -->
    <mat-card *ngIf="currentStep === 1" class="step-card">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>upload</mat-icon>
          Passo 1: Informe os IDs dos Clientes
        </mat-card-title>
      </mat-card-header>

      <mat-card-content>
        <!-- Input Method Selection -->
        <div class="input-method-selection">
          <h3>Método de Entrada:</h3>

          <!-- Manual Input -->
          <div class="method-option">
            <mat-icon>edit</mat-icon>
            <label>
              <input type="radio" formControlName="inputMethod" value="manual">
              Digitação Manual
            </label>
          </div>

          <!-- Excel Upload -->
          <div class="method-option">
            <mat-icon>file_upload</mat-icon>
            <label>
              <input type="radio" formControlName="inputMethod" value="excel">
              Upload de Arquivo Excel
            </label>
          </div>
        </div>

        <!-- Manual Input Area -->
        <div *ngIf="deletionForm.get('inputMethod')?.value === 'manual'" class="input-area">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>IDs dos Clientes (separados por vírgula)</mat-label>
            <textarea
              matInput
              formControlName="clientIdsText"
              placeholder="Ex: 123, 456, 789 ou cada ID em uma linha"
              rows="6"
              (input)="onClientIdsTextChange()">
            </textarea>
            <mat-hint>Digite os IDs separados por vírgula, espaço ou quebra de linha</mat-hint>
            <mat-error *ngIf="deletionForm.get('clientIdsText')?.hasError('required')">
              IDs são obrigatórios
            </mat-error>
            <mat-error *ngIf="deletionForm.get('clientIdsText')?.hasError('invalidFormat')">
              Formato inválido. Digite apenas números separados por vírgula.
            </mat-error>
            <mat-error *ngIf="deletionForm.get('clientIdsText')?.hasError('tooMany')">
              Máximo de 1000 IDs por operação.
            </mat-error>
          </mat-form-field>
        </div>

        <!-- Excel Upload Area -->
        <div *ngIf="deletionForm.get('inputMethod')?.value === 'excel'" class="upload-area">
          <div class="upload-zone" [class.has-file]="selectedFile">
            <input
              type="file"
              accept=".xls,.xlsx,.xlsm"
              (change)="onFileSelected($event)"
              #fileInput
              style="display: none;">

            <div *ngIf="!selectedFile" class="upload-placeholder">
              <mat-icon>cloud_upload</mat-icon>
              <p>Clique para selecionar arquivo Excel</p>
              <p class="upload-hint">Formatos aceitos: .xls, .xlsx, .xlsm</p>
              <button type="button" mat-raised-button color="primary" (click)="fileInput.click()">
                Selecionar Arquivo
              </button>
            </div>

            <div *ngIf="selectedFile" class="file-selected">
              <mat-icon>description</mat-icon>
              <span>{{ selectedFile.name }}</span>
              <button type="button" mat-icon-button (click)="selectedFile = null; fileInput.value = ''">
                <mat-icon>close</mat-icon>
              </button>
            </div>
          </div>

          <div *ngIf="isLoading" class="loading-indicator">
            <mat-progress-spinner mode="indeterminate" diameter="30"></mat-progress-spinner>
            <span>Processando arquivo...</span>
          </div>
        </div>

        <!-- IDs Summary -->
        <div *ngIf="clientIds.length > 0" class="ids-summary">
          <mat-icon>info</mat-icon>
          <span><strong>{{ formatNumber(clientIds.length) }}</strong> IDs carregados</span>
          <mat-chip-listbox>
            <mat-chip *ngFor="let id of clientIds.slice(0, 10)" selected>{{ id }}</mat-chip>
            <mat-chip *ngIf="clientIds.length > 10">+ {{ clientIds.length - 10 }} mais...</mat-chip>
          </mat-chip-listbox>
        </div>

        <!-- Required Fields -->
        <div class="required-fields">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Motivo da Exclusão</mat-label>
            <textarea
              matInput
              formControlName="reason"
              placeholder="Descreva o motivo da exclusão em massa..."
              rows="3">
            </textarea>
            <mat-hint>Mínimo de 10 caracteres</mat-hint>
            <mat-error *ngIf="deletionForm.get('reason')?.hasError('required')">
              Motivo é obrigatório
            </mat-error>
            <mat-error *ngIf="deletionForm.get('reason')?.hasError('minlength')">
              Motivo deve ter pelo menos 10 caracteres
            </mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Seu E-mail</mat-label>
            <input matInput formControlName="userEmail" placeholder="seu.email@empresa.com">
            <mat-hint>Para auditoria e controle</mat-hint>
            <mat-error *ngIf="deletionForm.get('userEmail')?.hasError('required')">
              E-mail é obrigatório
            </mat-error>
            <mat-error *ngIf="deletionForm.get('userEmail')?.hasError('email')">
              E-mail inválido
            </mat-error>
          </mat-form-field>
        </div>
      </mat-card-content>

      <mat-card-actions>
        <button
          type="button"
          mat-raised-button
          color="primary"
          (click)="goToValidation()"
          [disabled]="deletionForm.invalid || clientIds.length === 0 || isLoading">
          Validar Clientes
          <mat-icon>arrow_forward</mat-icon>
        </button>
      </mat-card-actions>
    </mat-card>

    <!-- Step 2: Validation -->
    <mat-card *ngIf="currentStep === 2" class="step-card">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>fact_check</mat-icon>
          Passo 2: Validação dos Clientes
        </mat-card-title>
      </mat-card-header>

      <mat-card-content>
        <div *ngIf="isValidating" class="loading-indicator">
          <mat-progress-spinner mode="indeterminate" diameter="40"></mat-progress-spinner>
          <span>Validando clientes...</span>
        </div>

        <div *ngIf="validationResult && !isValidating">
          <!-- Validation Summary -->
          <div class="validation-summary">
            <div class="summary-item valid">
              <mat-icon>check_circle</mat-icon>
              <span><strong>{{ formatNumber(validationResult.validIds.length) }}</strong> clientes válidos</span>
            </div>
            <div class="summary-item invalid" *ngIf="validationResult.invalidIds.length > 0">
              <mat-icon>error</mat-icon>
              <span><strong>{{ formatNumber(validationResult.invalidIds.length) }}</strong> IDs inválidos</span>
            </div>
          </div>

          <!-- Invalid IDs -->
          <mat-expansion-panel *ngIf="validationResult.invalidIds.length > 0" class="invalid-ids-panel">
            <mat-expansion-panel-header>
              <mat-panel-title>
                <mat-icon>warning</mat-icon>
                IDs Inválidos ({{ validationResult.invalidIds.length }})
              </mat-panel-title>
            </mat-expansion-panel-header>
            <div class="invalid-ids-list">
              <mat-chip-listbox>
                <mat-chip *ngFor="let id of validationResult.invalidIds" color="warn" selected>{{ id }}</mat-chip>
              </mat-chip-listbox>
            </div>
          </mat-expansion-panel>

          <!-- Valid Clients Table -->
          <div *ngIf="validationResult.clientDetails.length > 0" class="clients-table">
            <h3>Clientes que serão excluídos:</h3>
            <table mat-table [dataSource]="validationResult.clientDetails" class="full-width">
              <ng-container matColumnDef="id">
                <th mat-header-cell *matHeaderCellDef>ID</th>
                <td mat-cell *matCellDef="let client">{{ client.id }}</td>
              </ng-container>

              <ng-container matColumnDef="name">
                <th mat-header-cell *matHeaderCellDef>Nome</th>
                <td mat-cell *matCellDef="let client">{{ client.name }}</td>
              </ng-container>

              <ng-container matColumnDef="email">
                <th mat-header-cell *matHeaderCellDef>E-mail</th>
                <td mat-cell *matCellDef="let client">{{ client.email }}</td>
              </ng-container>

              <ng-container matColumnDef="registrationDate">
                <th mat-header-cell *matHeaderCellDef>Data Cadastro</th>
                <td mat-cell *matCellDef="let client">{{ formatDate(client.registrationDate) }}</td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="clientColumns.slice(1)"></tr>
              <tr mat-row *matRowDef="let row; columns: clientColumns.slice(1)"></tr>
            </table>
          </div>

          <!-- Affected Tables Stats -->
          <div *ngIf="affectedTablesStats.length > 0" class="affected-tables">
            <h3>Tabelas que serão afetadas:</h3>
            <table mat-table [dataSource]="affectedTablesStats" class="full-width">
              <ng-container matColumnDef="tableName">
                <th mat-header-cell *matHeaderCellDef>Tabela</th>
                <td mat-cell *matCellDef="let stat">{{ stat.tableName }}</td>
              </ng-container>

              <ng-container matColumnDef="recordCount">
                <th mat-header-cell *matHeaderCellDef>Registros</th>
                <td mat-cell *matCellDef="let stat">{{ formatNumber(stat.recordCount) }}</td>
              </ng-container>

              <ng-container matColumnDef="description">
                <th mat-header-cell *matHeaderCellDef>Descrição</th>
                <td mat-cell *matCellDef="let stat">{{ stat.description }}</td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="tableStatsColumns"></tr>
              <tr mat-row *matRowDef="let row; columns: tableStatsColumns"></tr>
            </table>

            <div class="total-records">
              <strong>Total de registros a serem excluídos: {{ formatNumber(getTotalRecordsToDelete()) }}</strong>
            </div>
          </div>
        </div>
      </mat-card-content>

      <mat-card-actions>
        <button type="button" mat-button (click)="goBack()" [disabled]="isValidating">
          <mat-icon>arrow_back</mat-icon>
          Voltar
        </button>
        <button
          type="button"
          mat-raised-button
          color="primary"
          (click)="goToConfirmation()"
          [disabled]="isValidating || !hasValidClients()">
          Continuar
          <mat-icon>arrow_forward</mat-icon>
        </button>
      </mat-card-actions>
    </mat-card>

    <!-- Step 3: Confirmation -->
    <mat-card *ngIf="currentStep === 3" class="step-card confirmation-card">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>warning</mat-icon>
          Passo 3: Confirmação Final
        </mat-card-title>
      </mat-card-header>

      <mat-card-content>
        <div class="confirmation-content">
          <div class="warning-box">
            <mat-icon>dangerous</mat-icon>
            <div>
              <h3>⚠️ OPERAÇÃO IRREVERSÍVEL</h3>
              <p>Você está prestes a excluir <strong>{{ formatNumber(getValidClientsCount()) }}</strong> clientes e <strong>{{ formatNumber(getTotalRecordsToDelete()) }}</strong> registros relacionados.</p>
              <p>Esta operação <strong>NÃO PODE SER DESFEITA</strong>.</p>
            </div>
          </div>

          <div class="confirmation-details">
            <h4>Resumo da operação:</h4>
            <ul>
              <li><strong>Clientes a excluir:</strong> {{ formatNumber(getValidClientsCount()) }}</li>
              <li><strong>Tabelas afetadas:</strong> {{ affectedTablesStats.length }}</li>
              <li><strong>Total de registros:</strong> {{ formatNumber(getTotalRecordsToDelete()) }}</li>
              <li><strong>Motivo:</strong> {{ deletionForm.get('reason')?.value }}</li>
              <li><strong>Responsável:</strong> {{ deletionForm.get('userEmail')?.value }}</li>
            </ul>
          </div>

          <div class="confirmation-checkbox">
            <mat-checkbox formControlName="confirmDeletion">
              <strong>Eu confirmo que entendo as consequências desta operação e autorizo a exclusão.</strong>
            </mat-checkbox>
          </div>
        </div>
      </mat-card-content>

      <mat-card-actions>
        <button type="button" mat-button (click)="goBack()">
          <mat-icon>arrow_back</mat-icon>
          Voltar
        </button>
        <button
          type="button"
          mat-raised-button
          color="warn"
          (click)="executeClients()"
          [disabled]="!deletionForm.get('confirmDeletion')?.value">
          <mat-icon>delete_forever</mat-icon>
          EXECUTAR EXCLUSÃO
        </button>
      </mat-card-actions>
    </mat-card>

    <!-- Step 4: Execution -->
    <mat-card *ngIf="currentStep === 4" class="step-card execution-card">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>sync</mat-icon>
          Passo 4: Execução da Exclusão
        </mat-card-title>
      </mat-card-header>

      <mat-card-content>
        <div *ngIf="isDeleting" class="execution-progress">
          <mat-progress-bar mode="determinate" [value]="getProgressPercentage()"></mat-progress-bar>
          <div class="progress-info">
            <span>{{ deletionProgress.status }}</span>
            <span>{{ deletionProgress.current }} / {{ deletionProgress.total }}</span>
          </div>
        </div>

        <div *ngIf="deletionResult && !isDeleting" class="execution-result">
          <div class="result-summary" [class.success]="deletionResult.success" [class.partial]="!deletionResult.success">
            <mat-icon>{{ deletionResult.success ? 'check_circle' : 'warning' }}</mat-icon>
            <div>
              <h3>{{ deletionResult.success ? 'Exclusão Concluída' : 'Exclusão Concluída com Erros' }}</h3>
              <p>{{ formatNumber(deletionResult.deletedCount) }} clientes excluídos com sucesso</p>
              <p *ngIf="deletionResult.failedCount > 0">{{ formatNumber(deletionResult.failedCount) }} falhas</p>
            </div>
          </div>

          <div class="log-download">
            <h4>Log da Operação:</h4>
            <button type="button" mat-raised-button color="primary" (click)="downloadLog()">
              <mat-icon>download</mat-icon>
              Baixar Log Completo ({{ deletionResult.logFileName }})
            </button>
          </div>

          <!-- Errors Summary -->
          <div *ngIf="deletionResult.errors?.length" class="errors-summary">
            <h4>Erros Encontrados:</h4>
            <ul>
              <li *ngFor="let error of deletionResult.errors">{{ error }}</li>
            </ul>
          </div>
        </div>
      </mat-card-content>

      <mat-card-actions>
        <button type="button" mat-raised-button color="primary" (click)="resetProcess()" [disabled]="isDeleting">
          <mat-icon>refresh</mat-icon>
          Nova Exclusão
        </button>
      </mat-card-actions>
    </mat-card>

  </form>
</div>